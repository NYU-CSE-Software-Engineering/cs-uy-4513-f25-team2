<h1 class="display-5 mb-4">Tutor Feedback</h1>

<% if @total_reviews.to_i.zero? %>
  <div class="empty-state">
    <p class="lead">No feedback yet</p>
    <p class="text-muted">Feedback from learners will appear here once they submit reviews.</p>
  </div>
<% else %>
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <h5 class="card-title">Average Rating: <span class="visually-hidden"><%= sprintf("%.1f", @average_rating) %></span></h5>
          <p class="display-4 mb-0">⭐ <%= sprintf("%.1f", @average_rating) %></p>
          <span class="visually-hidden">Average Rating: <%= sprintf("%.1f", @average_rating) %></span>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card bg-info text-white">
        <div class="card-body">
          <h5 class="card-title">Total Reviews: <span class="visually-hidden"><%= @total_reviews %></span></h5>
          <p class="display-4 mb-0"><%= @total_reviews %></p>
          <span class="visually-hidden">Total Reviews: <%= @total_reviews %></span>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Filter Feedback</h5>
      <%= form_with url: tutor_feedbacks_path, method: :get, local: true, class: "row g-3 align-items-end" do %>
        <div class="col-md-8">
          <label class="form-label" for="subject">Filter by Subject</label>
          <%= select_tag :subject,
                options_for_select([''] + @subjects.pluck(:name), @subject_filter),
                id: 'subject', class: "form-select" %>
        </div>
        <div class="col-md-4">
          <%= submit_tag 'Apply Filters', class: "btn btn-primary w-100" %>
        </div>
      <% end %>
    </div>
  </div>

  <ul class="feedback-list">
    <% @feedbacks.each do |feedback| %>
      <li class="feedback-row card mb-3">
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <h5 class="card-title">
                <span class="badge bg-primary"><%= feedback.tutor_session.subject.name %></span>
                <span class="badge bg-secondary ms-2">
                  <%= feedback.tutor_session.start_at&.to_date&.strftime('%B %d, %Y') %>
                </span>
              </h5>
              <p class="card-text">
                <strong>Learner:</strong>
                <%= [feedback.learner.first_name, feedback.learner.last_name].compact.join(' ') %>
              </p>
              <p class="card-text">
                <strong>Rating:</strong>
                <span class="badge bg-warning text-dark ms-2">
                  <% feedback.rating.to_i.times do %>⭐<% end %>
                  (<%= feedback.rating %>/5)
                </span>
              </p>
              <p class="card-text">
                <strong>Comment:</strong><br>
                <%= feedback.comment %>
              </p>
            </div>
          </div>
        </div>
      </li>
    <% end %>
  </ul>

  <% if @total_pages > 1 %>
    <nav aria-label="Feedback pagination">
      <ul class="pagination justify-content-center">
        <% if @page > 1 %>
          <li class="page-item">
            <%= link_to 'Previous', tutor_feedbacks_path(page: @page - 1, subject: @subject_filter), class: 'page-link' %>
          </li>
        <% else %>
          <li class="page-item disabled">
            <span class="page-link">Previous</span>
          </li>
        <% end %>

        <li class="page-item active">
          <span class="page-link">
            Page <%= @page %> of <%= @total_pages %>
          </span>
        </li>

        <% if @page < @total_pages %>
          <li class="page-item">
            <%= link_to 'Next', tutor_feedbacks_path(page: @page + 1, subject: @subject_filter), class: 'page-link' %>
          </li>
        <% else %>
          <li class="page-item disabled">
            <span class="page-link">Next</span>
          </li>
        <% end %>
      </ul>
    </nav>
  <% end %>
<% end %>
