<h1 class="display-5 mb-4">Session Details</h1>

<div class="row">
  <div class="col-md-8">
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title h4 mb-3">Session Information</h2>
        <dl class="row">
          <dt class="col-sm-3">Subject:</dt>
          <dd class="col-sm-9">
            <span class="badge bg-primary"><%= @tutor_session.subject.name %></span>
          </dd>
          
          <dt class="col-sm-3">Start:</dt>
          <dd class="col-sm-9"><%= @tutor_session.start_at.strftime('%B %d, %Y at %I:%M %p') %></dd>
          
          <dt class="col-sm-3">End:</dt>
          <dd class="col-sm-9"><%= @tutor_session.end_at.strftime('%B %d, %Y at %I:%M %p') %></dd>
          
          <dt class="col-sm-3">Status:</dt>
          <dd class="col-sm-9">
            <span class="badge bg-<%= @tutor_session.status == 'active' ? 'success' : 'secondary' %>">
              <%= @tutor_session.status %>
            </span>
          </dd>
          
          <% if @tutor_session.meeting_link.present? %>
            <dt class="col-sm-3">Meeting link:</dt>
            <dd class="col-sm-9">
              <%= link_to 'Join Session', @tutor_session.meeting_link, target: '_blank', class: "btn btn-success btn-sm" %>
            </dd>
          <% end %>
        </dl>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h2 class="card-title h4 mb-3">Attendees</h2>
        <% learners = @tutor_session.learners
               .joins(:session_attendees)
               .where(session_attendees: { cancelled: false })
               .where.not(id: @tutor_session.tutor.learner.id) %>
        <% learners.each do |learner| %>
          <% attendee = SessionAttendee.find_by(tutor_session: @tutor_session, learner: learner) %>
          <% attended_status = attendee&.attended %>
          <div class="card mb-3">
            <div class="card-body">
              <p class="card-text"><strong>Learner:</strong><%= [learner&.first_name, learner&.last_name].compact.join(" ").presence || "N/A" %></p>
              <% if @tutor_session.start_at <= Time.current %>
                <%= form_with url: session_path(@tutor_session), method: :patch, local: true do %>
                  <%= hidden_field_tag 'session_attendee[learner_id]', learner.id %>
                  
                  <div class="mb-3">
                    <div class="form-check">
                      <%= radio_button_tag 'session_attendee[attended]', 'true', attended_status == true, id: "attended_true_#{learner.id}", class: "form-check-input" %>
                      <%= label_tag "attended_true_#{learner.id}", 'Present', class: "form-check-label" %>
                    </div>
                    
                    <div class="form-check">
                      <%= radio_button_tag 'session_attendee[attended]', 'false', attended_status == false, id: "attended_false_#{learner.id}", class: "form-check-input" %>
                      <%= label_tag "attended_false_#{learner.id}", 'Absent', class: "form-check-label" %>
                    </div>
                  </div>
                  
                  <%= submit_tag 'Save', class: "btn btn-primary btn-sm" %>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
